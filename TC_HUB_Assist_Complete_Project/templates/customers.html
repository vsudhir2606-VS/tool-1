{% extends "base.html" %}

{% block title %}Customers - Screening Tool{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>Customer Management</h2>
        <div class="mb-3">
            <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addCustomerModal">Add New Customer</button>
            <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#uploadCustomersModal">
                <i class="fas fa-file-excel"></i> Import from Excel
            </button>
            <button class="btn btn-danger" id="deleteSelectedCustomers" disabled>
                <i class="fas fa-trash"></i> Delete Selected
            </button>
            <form id="downloadSelectedCustomersForm" method="POST" action="/api/download-selected-customers" style="display: inline;">
                <button type="button" class="btn btn-success" id="downloadSelectedCustomers" disabled>
                    <i class="fas fa-download"></i> Download Selected
                </button>
            </form>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAllCustomers"></th>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Address</th>
                        <th>Phone</th>
                        <th>Email</th>
                        <th>Comments</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="customersTable">
                    {% for customer in customers %}
                    <tr>
                        <td><input type="checkbox" class="customer-checkbox" value="{{ customer.id }}"></td>
                        <td>{{ customer.id }}</td>
                        <td>{{ customer.name }}</td>
                        <td>{{ customer.address or 'N/A' }}</td>
                        <td>{{ customer.phone or 'N/A' }}</td>
                        <td>{{ customer.email or 'N/A' }}</td>
                        <td>{{ customer.comments or 'N/A' }}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary edit-customer" data-id="{{ customer.id }}">Edit</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Customer Modal -->
<div class="modal fade" id="addCustomerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="customerForm">
                    <div class="mb-3">
                        <label for="customerName" class="form-label">Name *</label>
                        <input type="text" class="form-control" id="customerName" required>
                    </div>
                    <div class="mb-3">
                        <label for="customerAddress" class="form-label">Address</label>
                        <input type="text" class="form-control" id="customerAddress">
                    </div>
                    <div class="mb-3">
                        <label for="customerPhone" class="form-label">Phone</label>
                        <input type="text" class="form-control" id="customerPhone">
                    </div>
                    <div class="mb-3">
                        <label for="customerEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="customerEmail">
                    </div>
                    <div class="mb-3">
                        <label for="customerComments" class="form-label">Comments</label>
                        <textarea class="form-control" id="customerComments" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveCustomer">Save Customer</button>
            </div>
        </div>
    </div>
</div>

<!-- Upload Customers Modal -->
<div class="modal fade" id="uploadCustomersModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import Customers from Excel</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <strong>Excel Format Requirements:</strong>
                    <ul class="mb-0 mt-2">
                        <li><strong>Required:</strong> Name column (cannot be empty)</li>
                        <li><strong>Optional:</strong> Address, Phone, Email, Comments columns</li>
                        <li>Column names must match exactly (case-sensitive)</li>
                        <li>File must be .xlsx or .xls format</li>
                    </ul>
                </div>
                <div class="alert alert-warning">
                    <small><strong>Sample format:</strong></small>
                    <table class="table table-sm mt-1 mb-0">
                        <thead>
                            <tr><th>Name</th><th>Address</th><th>Phone</th><th>Email</th><th>Comments</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>John Doe</td><td>123 Main St</td><td>555-0123</td><td>john@email.com</td><td>VIP Customer</td></tr>
                        </tbody>
                    </table>
                </div>
                <form id="uploadCustomersForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="customersFile" class="form-label">Select Excel File</label>
                        <input type="file" class="form-control" id="customersFile" accept=".xlsx,.xls" required>
                    </div>
                </form>
                <div id="uploadProgress" class="mt-3" style="display: none;">
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                <div id="uploadMessage" class="mt-3" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="uploadCustomersBtn">Upload and Import</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Customer Modal -->
<div class="modal fade" id="editCustomerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editCustomerForm">
                    <input type="hidden" id="editCustomerId">
                    <div class="mb-3">
                        <label for="editCustomerName" class="form-label">Name *</label>
                        <input type="text" class="form-control" id="editCustomerName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editCustomerAddress" class="form-label">Address</label>
                        <input type="text" class="form-control" id="editCustomerAddress">
                    </div>
                    <div class="mb-3">
                        <label for="editCustomerPhone" class="form-label">Phone</label>
                        <input type="text" class="form-control" id="editCustomerPhone">
                    </div>
                    <div class="mb-3">
                        <label for="editCustomerEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="editCustomerEmail">
                    </div>
                    <div class="mb-3">
                        <label for="editCustomerComments" class="form-label">Comments</label>
                        <textarea class="form-control" id="editCustomerComments" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateCustomer">Update Customer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Add customer
    $('#saveCustomer').click(function() {
        const data = {
            name: $('#customerName').val(),
            address: $('#customerAddress').val(),
            phone: $('#customerPhone').val(),
            email: $('#customerEmail').val(),
            comments: $('#customerComments').val()
        };

        $.ajax({
            url: '/api/customers',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                location.reload();
            },
            error: function() {
                alert('Error adding customer');
            }
        });
    });

    // Edit customer
    $('.edit-customer').click(function() {
        const customerId = $(this).data('id');
        const row = $(this).closest('tr');

        $('#editCustomerId').val(customerId);
        $('#editCustomerName').val(row.find('td:eq(2)').text());
        $('#editCustomerAddress').val(row.find('td:eq(3)').text() === 'N/A' ? '' : row.find('td:eq(3)').text());
        $('#editCustomerPhone').val(row.find('td:eq(4)').text() === 'N/A' ? '' : row.find('td:eq(4)').text());
        $('#editCustomerEmail').val(row.find('td:eq(5)').text() === 'N/A' ? '' : row.find('td:eq(5)').text());
        $('#editCustomerComments').val(row.find('td:eq(6)').text() === 'N/A' ? '' : row.find('td:eq(6)').text());

        $('#editCustomerModal').modal('show');
    });

    // Select all customers checkbox
    $('#selectAllCustomers').change(function() {
        $('.customer-checkbox').prop('checked', this.checked);
        updateButtonStates();
    });

    // Individual checkbox change
    $(document).on('change', '.customer-checkbox', function() {
        updateButtonStates();

        // Update select all checkbox
        const totalCheckboxes = $('.customer-checkbox').length;
        const checkedCheckboxes = $('.customer-checkbox:checked').length;

        if (checkedCheckboxes === 0) {
            $('#selectAllCustomers').prop('indeterminate', false).prop('checked', false);
        } else if (checkedCheckboxes === totalCheckboxes) {
            $('#selectAllCustomers').prop('indeterminate', false).prop('checked', true);
        } else {
            $('#selectAllCustomers').prop('indeterminate', true);
        }
    });

    function updateButtonStates() {
        const checkedCount = $('.customer-checkbox:checked').length;
        $('#deleteSelectedCustomers').prop('disabled', checkedCount === 0);
        $('#downloadSelectedCustomers').prop('disabled', checkedCount === 0);
    }

    // Delete selected customers
    $('#deleteSelectedCustomers').click(function() {
        const selectedIds = $('.customer-checkbox:checked').map(function() {
            return $(this).val();
        }).get();

        if (selectedIds.length === 0) {
            alert('Please select customers to delete');
            return;
        }

        if (confirm(`Are you sure you want to delete ${selectedIds.length} selected customer(s)?`)) {
            let deletedCount = 0;
            const totalToDelete = selectedIds.length;

            selectedIds.forEach(function(customerId) {
                $.ajax({
                    url: `/api/customers/${customerId}`,
                    method: 'DELETE',
                    success: function() {
                        deletedCount++;
                        if (deletedCount === totalToDelete) {
                            alert(`Successfully deleted ${deletedCount} customer(s)`);
                            location.reload();
                        }
                    },
                    error: function() {
                        alert(`Error deleting customer ID: ${customerId}`);
                    }
                });
            });
        }
    });

    // Update customer
    $('#updateCustomer').click(function() {
        const customerId = $('#editCustomerId').val();
        const data = {
            name: $('#editCustomerName').val(),
            address: $('#editCustomerAddress').val(),
            phone: $('#editCustomerPhone').val(),
            email: $('#editCustomerEmail').val(),
            comments: $('#editCustomerComments').val()
        };

        $.ajax({
            url: `/api/customers/${customerId}`,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                location.reload();
            },
            error: function() {
                alert('Error updating customer');
            }
        });
    });

    // Upload customers
    $('#uploadCustomersBtn').click(function() {
        const fileInput = $('#customersFile')[0];
        const file = fileInput.files[0];

        if (!file) {
            showUploadMessage('Please select a file', 'danger');
            return;
        }

        const fileName = file.name.toLowerCase();
        if (!fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
            showUploadMessage('Please select a valid Excel file (.xlsx or .xls)', 'danger');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        $('#uploadProgress').show();
        $('#uploadMessage').hide();
        $('.progress-bar').css('width', '25%');
        $('#uploadCustomersBtn').prop('disabled', true).text('Uploading...');

        $.ajax({
            url: '/api/upload-customers',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                $('.progress-bar').css('width', '100%');
                showUploadMessage(`Successfully imported ${response.imported_count} customers!`, 'success');
                setTimeout(() => {
                    location.reload();
                }, 1500);
            },
            error: function(xhr) {
                $('.progress-bar').css('width', '0%');
                $('#uploadProgress').hide();
                const error = xhr.responseJSON ? xhr.responseJSON.error : 'Upload failed. Please check your file format.';
                showUploadMessage(`Error: ${error}`, 'danger');
            },
            complete: function() {
                $('#uploadCustomersBtn').prop('disabled', false).text('Upload and Import');
            }
        });
    });

    // Download selected customers
    $('#downloadSelectedCustomers').click(function() {
        const selectedIds = $('.customer-checkbox:checked').map(function() {
            return $(this).val();
        }).get();

        if (selectedIds.length === 0) {
            alert('Please select customers to download');
            return;
        }

        // Add selected IDs to the hidden input fields within the form
        $('#downloadSelectedCustomersForm').empty(); // Clear previous selections if any
        selectedIds.forEach(function(id) {
            $('#downloadSelectedCustomersForm').append($('<input>', {
                type: 'hidden',
                name: 'selected_ids',
                value: id
            }));
        });

        // Submit the form to trigger the download
        $('#downloadSelectedCustomersForm').submit();
    });


    function showUploadMessage(message, type) {
        $('#uploadMessage')
            .removeClass('alert-success alert-danger alert-warning')
            .addClass(`alert alert-${type}`)
            .html(message)
            .show();
    }
});
</script>
{% endblock %}